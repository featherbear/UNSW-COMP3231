<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Assignment 3 - COMP3231 Musings</title><meta name=renderer content=webkit><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta name=theme-color content=#f8f5ec><meta name=msapplication-navbutton-color content=#f8f5ec><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#f8f5ec><meta name=author content=z5206677><meta name=description content="Diagram  In this assignment you will implement the virtual memory sub-system of OS/161."><meta name=keywords content=Hugo,theme,even><meta name=generator content="Hugo 0.58.2 with theme even"><link rel=canonical href=../../post/assignment-3/><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../manifest.json><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><link href=../../dist/even.c2a46f00.min.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><link rel=stylesheet href=../../css/typedjs.shortcode.css><meta property=og:title content="Assignment 3"><meta property=og:description content="Diagram  In this assignment you will implement the virtual memory sub-system of OS/161."><meta property=og:type content=article><meta property=og:url content=/post/assignment-3/><meta property=article:published_time content=2020-04-15T16:48:20+10:00><meta property=article:modified_time content=2020-04-15T16:48:20+10:00><meta itemprop=name content="Assignment 3"><meta itemprop=description content="Diagram  In this assignment you will implement the virtual memory sub-system of OS/161."><meta itemprop=datePublished content=2020-04-15T16:48:20&#43;10:00><meta itemprop=dateModified content=2020-04-15T16:48:20&#43;10:00><meta itemprop=wordCount content=1144><meta itemprop=keywords content><meta name=twitter:card content=summary><meta name=twitter:title content="Assignment 3"><meta name=twitter:description content="Diagram  In this assignment you will implement the virtual memory sub-system of OS/161."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=../../ class=logo>COMP3231 Musings</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=../../><li class=mobile-menu-item>Home</li></a><a href=https://github.com/featherbear/UNSW-COMP3231><li class=mobile-menu-item>GitHub</li></a><a href=../../categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=../../ class=logo>COMP3231 Musings</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=../../>Home</a></li><li class=menu-item><a class=menu-item-link href=https://github.com/featherbear/UNSW-COMP3231>GitHub</a></li><li class=menu-item><a class=menu-item-link href=../../categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Assignment 3</h1><div class=post-meta><span class=post-time>2020-04-15</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#diagram>Diagram</a></li><li><a href=#the-system-161-tlb>The System/161 TLB</a></li><li><a href=#tlb-access-procedure>TLB Access Procedure</a></li><li><a href=#memory-regions>Memory Regions</a></li><li><a href=#address-space-management>Address Space Management</a></li><li><a href=#address-translation>Address Translation</a></li><li><a href=#hints>Hints</a></li><li><a href=#linux-file-permission-to-page-table-bits>Linux File Permission to Page Table Bits</a></li><li><a href=#tlb-data>TLB Data</a></li><li><a href=#struct-addrspace>struct addrspace</a></li><li><a href=#clearing-the-tlb>Clearing the TLB</a></li><li><a href=#memory-mapping>Memory Mapping</a></li><li><a href=#vm-fault>vm_fault</a></li><li><a href=#tests-click-image-to-zoom>Tests (Click image to zoom)</a></li></ul></nav></div></div><div class=post-content><h1 id=diagram>Diagram</h1><p><img src=sketch.png alt></p><hr><blockquote><p>In this assignment you will implement the virtual memory sub-system of OS/161. The existing VM implementation in OS/161, dumbvm, is a minimal implementation with a number of shortcomings. In this assignment you will adapt OS/161 to take full advantage of the simulated hardware by implementing management of the MIPS software-managed Translation Lookaside Buffer (TLB). You will write the code to manage this TLB.</p></blockquote><h1 id=the-system-161-tlb>The System/161 TLB</h1><p>In the System/161 machine, each TLB entry includes a 20-bit virtual page number and a 20-bit physical page number as well as the following five fields:</p><ul><li><s><code>global</code>: 1 bit; if set, ignore the PID bits in the TLB.</s></li><li><code>valid</code>: 1 bit; set if the TLB entry contains a valid translation.</li><li><code>dirty</code>: 1 bit; enables writing to the page referenced by the entry; if this bit is 0, the page is only accessible for reading.</li><li><s><code>nocache</code>: 1 bit; unused in System/161. In a real processor, indicates that the hardware cache will be disabled when accessing this page.</s></li><li><s><code>asid</code>: 6 bits; a context or address space ID that can be used to allow entries to remain in the TLB after a context switch.</s></li></ul><p><strong><em>NOTE: Crossed out ones are not needed in os161.</em></strong></p><p>All these bits/values are maintained by the operating system (i.e. your code). When the valid bit is set, the TLB entry contains a valid translation. This implies that the virtual page is present in physical memory. A TLB miss occurs when no TLB entry can be found with a matching virtual page and address space ID (unless the global bit is set in which case the address space ID is ignored) and a valid bit that is set.</p><p>For this assignment, you may largely ignore the ASID field set to zero for your TLB entries. Note, however, that you must then flush the TLB on a context switch.<br><strong>Why: The ASID field corresponds TLB entries to the correct process. Without ASID field, we need to force all TLB entries to be invalid - so that a new process can not match a TLB entry that existed before its context switch.</strong></p><h1 id=tlb-access-procedure>TLB Access Procedure</h1><p>(1) Check if entry is VALID<br>(2) Check if GLOBAL<br>[3] [if not global] Check ASID (not needed in os161 if a TLB flush is performed)
(4) Set DIRTY</p><h1 id=memory-regions>Memory Regions</h1><ul><li><code>kseg2</code> - TLB-mapped cacheable kernel space - <code>0xc0000000</code> to <code>0xffffffff</code></li><li><code>kseg1</code> - direct-mapped uncached kernel space - <code>0xa0000000</code> to <code>0xbfffffff</code></li><li><code>kseg0</code> - direct-mapped cached kernel space - <code>0x80000000</code> to <code>0x9fffffff</code></li><li><code>kuseg</code> - TLB-mapped cacheable user space - <code>0x00000000</code> to <code>0x7fffffff</code></li></ul><h1 id=address-space-management>Address Space Management</h1><p>OS/161 has an address space data type that encapsulates the book-keeping needed to describe an address space: <code>struct addrspace</code>.<br>To enable OS/161 to interact with your VM implementation, you will need to implement the functions in <code>kern/vm/addrspace.c</code> and potentially modify the data type. The semantics of these functions is documented in <code>kern/include/addrspace.h</code>.</p><p><em>Note: You may use a fixed-size stack region (say 16 pages) for each process.</em></p><h1 id=address-translation>Address Translation</h1><p><img src="Screenshot from 2020-04-15 18-45-38.png" alt></p><p>The main goal for this assignment is to provide virtual memory translation for user programs.<br>To do this, you will need to implement a <strong><em>TLB refill handler</em></strong>. You will also need to implement a <strong><em>page table</em></strong>.<br>For this assignment, you will implement a 2-level hierarchical page table.</p><blockquote><p><a href="https://www.youtube.com/watch?v=8kBPRrHOTwg">Udacity - Two Level Page Tables</a><br>Split the MSB into two segments. First MSB indexes to a second table, second MSB indexes to the correct frame<br><a href=https://people.csail.mit.edu/rinard/teaching/osnotes/h11.html>MIT Notes</a></p></blockquote><p>Note that a hierarchical page table is a lazy data-structure.<br>This means that the contents of the page table, including the second-level nodes in the hierarchy, are only allocated when they are needed.</p><p>You may find allocating the required pages at load time helps you start your assignment, however, <strong><em>your final solution should allocate pages only when a page-fault occurs</em></strong>.</p><ul><li>What information do you need to store for each page?</li><li>How does the page table get populated?</li></ul><p>Note: Applications expect pages to contain zeros when first used.<br>This implies that newly allocated frames that are used to back pages should be <strong><em>zero-filled prior to mapping</em></strong></p><h1 id=hints>Hints</h1><p>To implement a page table, have a close look at the <code>dumbvm</code> implementation, especially <code>vm_fault()</code>.<br>Although it is simple, you should get an idea on how to approach the rest of the assignment.</p><p>One approach to implementing the assignment is in the following order:</p><ul><li>Understand how the page table works, and its relationship with the TLB.</li><li>Understand the specification and the supplied code.</li><li>Work out a basic design for your page table implementation.</li><li>Modify <code>kern/vm/vm.c</code> to insert, lookup, and update page table entries, and keep the TLB consistent with the page table.</li><li>Implement the TLB exception handlers in vm.c using your page table.</li><li>Implement the functions in <code>kern/vm/addrspace.c</code> that are required for basic functionality (e.g. <code>as_create()</code>, <code>as_prepare_load()</code>, etc.). Allocating user pages in <code>as_define_region()</code> may also simplify your assignment, however good solution allocate pages in <code>vm_fault()</code>.</li><li>Test and debug this. Use the debugger!</li></ul><p>Note: Interrupts should be disabled when writing to the TLB, see <code>dumbvm</code> for an example.<br>Otherwise, unexpected concurrency issues can occur.</p><p><code>as_activate()</code> and <code>as_deactivate()</code> can be copied from dumbvm.</p><h1 id=linux-file-permission-to-page-table-bits>Linux File Permission to Page Table Bits</h1><table><thead><tr><th align=center>Linux</th><th align=center>Page Table</th></tr></thead><tbody><tr><td align=center>rwx</td><td align=center>DV</td></tr><tr><td align=center>rw-</td><td align=center>DV</td></tr><tr><td align=center>r-x</td><td align=center>-V</td></tr><tr><td align=center>r&ndash;</td><td align=center>-V</td></tr><tr><td align=center>-wx</td><td align=center>DV</td></tr><tr><td align=center>-w-</td><td align=center>DV</td></tr><tr><td align=center>&ndash;x</td><td align=center>-V</td></tr><tr><td align=center>&mdash;</td><td align=center>&ndash;</td></tr></tbody></table><h1 id=tlb-data>TLB Data</h1><p>Look at the MIPS R300 manual page: 6-3.</p><p>Two 4-byte registers represent a TLB entry&hellip;<br>EntryHi:EntryLo</p><ul><li>EntryHi: 20 bits - VPN, 6 bits - ASID (ignore for OS161), 6 bits - 000000</li><li><p>EntryLo: 20 bits - PFN, 1 bit - Non-Cacheable (ignore for OS161), 1 bit - Dirty, 1 bit - Valid, 1 bit - Global</p></li><li><p>Can keep ASID as 0</p></li><li><p>tlb_probe to check if it is valid / exists</p></li><li><p>Always use <code>tlb_random</code> - we are not assessed on any efficient TLB algorithm.</p></li></ul><h1 id=struct-addrspace>struct addrspace</h1><p><code>struct addrspace</code> contains our two level page table (add a pointer)</p><ul><li><code>as_prepare_load</code> -&gt; load with vop_write; force writable (ie writing)</li><li><code>as_complete_load</code> -&gt; reset read write permissions</li></ul><h1 id=clearing-the-tlb>Clearing the TLB</h1><ul><li>Disable interrupts - <code>int spl = splhigh()</code></li><li>Write invalid entries into the TLB - <code>tlb_write(TLBHI_INVALID(i), TLBLO_INVALID(), i)</code></li><li>Enable interrupts - <code>splx(spl)</code></li></ul><p>Clear the TLB in as_activate() and as_deactivate()</p><h1 id=memory-mapping>Memory Mapping</h1><ul><li>kseg2 - 1GB</li><li>kseg1 - 512MB non-cacheable</li><li>kseg0 - 512MB cacheable</li><li><p>useg - 2GB</p></li><li><p>Start stack address at USERSTACK</p></li></ul><h1 id=vm-fault>vm_fault</h1><ul><li>Check if fault address is null<ul><li>Return <code>EFAULT</code> if address is null</li></ul></li><li>Check fault type<ul><li>Return <code>EFAULT</code> if fault type is read only</li><li>Return <code>EINVAL</code> if fault type is not read nor write</li></ul></li><li>Check page table<ul><li>If page entry doesn&rsquo;t exist, then allocate a new frame (<code>KVADDR_TO_PADDR(alloc_kpages(1))</code>)</li></ul></li><li>Check the access flags for the matched memory region in the address space</li><li>Store the value into the TLB (<code>tlb_random(entryHi, entryLo)</code>)<ul><li>Write fault address into the 10 MSB of entryHi</li><li>Write physical address into the 10 MSB of entryLo</li><li>Write Dirty and Valid bits into entryLo according to <a href=#linux-file-permission-to-page-table-bits>this table</a></li></ul></li></ul><h1 id=tests-click-image-to-zoom>Tests (Click image to zoom)</h1><table><thead><tr><th align=center><code>/bin/true</code></th><th align=center><code>/testbin/faulter</code></th><th align=center><code>/testbin/crash</code></th><th align=center><code>/testbin/huge</code></th><th align=center><code>/testbin/triplehuge</code></th><th align=center><code>/testbin/parallelvm</code></th></tr></thead><tbody><tr><td align=center><img src=Snipaste_2020-04-26_16-29-22.png alt></td><td align=center><img src=Snipaste_2020-04-26_16-24-33.png alt></td><td align=center><img src=Snipaste_2020-04-26_16-25-18.png alt></td><td align=center><img src=Snipaste_2020-04-26_16-29-47.png alt></td><td align=center><img src=Snipaste_2020-04-26_16-30-08.png alt></td><td align=center><img src=Snipaste_2020-04-26_16-26-08.png alt></td></tr></tbody></table></div><footer class=post-footer><nav class=post-nav><a class=prev href=../../post/virtual-memory/><i class="iconfont icon-left"></i><span class="prev-text nav-default">Virtual Memory</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=../../post/tut10/><span class="next-text nav-default">Tutorial Week 10</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:z5206677@student.unsw.edu.au class="iconfont icon-email" title=email></a><a href=https://www.linkedin.com/in/andrewjinmengwong/ class="iconfont icon-linkedin" title=linkedin></a><a href=https://github.com/featherbear class="iconfont icon-github" title=github></a><a href=https://www.instagram.com/_andrewjwong/ class="iconfont icon-instagram" title=instagram></a><a href=../../index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>Andrew Wong (z5206677)</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=../../dist/even.26188efa.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-107434487-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=../../js/typed.js@2.0.9></script><script src=../../js/typedjs.shortcode.js></script></body></html>